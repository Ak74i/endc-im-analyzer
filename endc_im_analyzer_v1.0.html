<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ENDC IM Analysis Tool - RF Engineering</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            margin: 0; padding: 20px; background: #f8fafc; color: #2d3748; 
        }
        
        .header {
            background: linear-gradient(135deg, #4299e1 0%, #3182ce 100%);
            color: white; padding: 30px; border-radius: 12px; text-align: center; margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(66, 153, 225, 0.3);
        }
        
        .header h1 { margin: 0 0 10px 0; font-size: 2.4em; font-weight: 600; }
        .header p { margin: 0; opacity: 0.95; font-size: 1.1em; }
        
        .disclaimer {
            background: #fff3cd; border: 2px solid #ffc107; border-radius: 8px;
            padding: 15px; margin-bottom: 20px; color: #856404;
        }
        .disclaimer strong { display: block; margin-bottom: 8px; font-size: 1.1em; }
        
        .upload-section {
            background: white; padding: 30px; border-radius: 12px; text-align: center; 
            margin-bottom: 20px; box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .file-input {
            display: none;
        }
        
        .file-label {
            display: inline-block; padding: 15px 30px; background: #4299e1; color: white;
            border-radius: 8px; cursor: pointer; font-size: 16px; font-weight: 600;
            transition: all 0.3s; border: 2px solid #4299e1;
        }
        
        .file-label:hover {
            background: #3182ce; border-color: #3182ce; transform: translateY(-2px);
        }
        
        .processing {
            display: none; color: #4299e1; font-size: 18px; margin-top: 20px;
        }
        
        .stats { 
            display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); 
            gap: 20px; margin-bottom: 30px; 
        }
        
        .stat-card { 
            background: white; padding: 25px; border-radius: 12px; text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08); transition: transform 0.2s;
        }
        .stat-card:hover { transform: translateY(-3px); }
        .stat-number { font-size: 2.5em; font-weight: bold; margin: 10px 0; color: #4299e1; }
        
        .section {
            background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .section h3 {
            margin: 0 0 20px 0; color: #2d3748; font-size: 1.4em;
            border-bottom: 2px solid #e2e8f0; padding-bottom: 10px;
        }
        
        .carrier-heatmap {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
            gap: 10px; margin: 20px 0;
        }
        
        .carrier-cell {
            background: white; border: 2px solid #e2e8f0; border-radius: 8px;
            padding: 15px 10px; text-align: center; cursor: pointer;
            transition: all 0.3s; position: relative;
        }
        
        .carrier-cell:hover { transform: scale(1.05); }
        
        .carrier-name { font-weight: bold; font-size: 14px; margin-bottom: 8px; }
        .carrier-risk { font-size: 20px; font-weight: bold; }
        .carrier-count { font-size: 11px; color: #666; margin-top: 5px; }
        
        /* Risk level colors */
        .risk-critical { background: #fed7d7; border-color: #e53e3e; color: #c53030; }
        .risk-high { background: #feebc8; border-color: #dd6b20; color: #c05621; }
        .risk-medium { background: #bee3f8; border-color: #3182ce; color: #2c5282; }
        .risk-low { background: #c6f6d5; border-color: #38a169; color: #2f855a; }
        .risk-minimal { background: #f7fafc; border-color: #e2e8f0; color: #4a5568; }
        
        .combinations-table {
            width: 100%; border-collapse: collapse; font-size: 13px;
            margin-top: 20px; max-height: 600px; overflow-y: auto; display: block;
        }
        
        .combinations-table thead, .combinations-table tbody {
            display: table; width: 100%; table-layout: fixed;
        }
        
        .combinations-table th {
            background: linear-gradient(135deg, #2d3748 0%, #1a202c 100%); 
            color: white; padding: 12px 8px; text-align: left; font-weight: 600;
            position: sticky; top: 0; z-index: 5;
        }
        
        .combinations-table td { 
            padding: 10px 8px; border-bottom: 1px solid #e2e8f0; 
            vertical-align: middle; 
        }
        
        .combinations-table tbody tr:hover { background: #f7fafc; cursor: pointer; }
        
        .risk-score {
            font-weight: bold; font-size: 14px; padding: 4px 8px;
            border-radius: 4px; text-align: center; min-width: 50px;
        }
        
        .score-critical { background: #fed7d7; color: #c53030; }
        .score-high { background: #feebc8; color: #c05621; }
        .score-medium { background: #bee3f8; color: #2c5282; }
        .score-low { background: #c6f6d5; color: #2f855a; }
        .score-minimal { background: #f7fafc; color: #4a5568; }
        
        .interference-list {
            max-height: 150px; overflow-y: auto; 
            background: #f7fafc; padding: 8px; border-radius: 6px;
            font-size: 11px; margin-top: 5px;
        }
        
        .interference-item {
            padding: 2px 0; border-bottom: 1px solid #e2e8f0;
        }
        
        .im2 { color: #e53e3e; font-weight: bold; }
        .im3 { color: #dd6b20; font-weight: bold; }
        
        .controls {
            background: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
        }
        
        .search { 
            width: 100%; max-width: 500px; padding: 14px 20px; border: 2px solid #e2e8f0;
            border-radius: 8px; font-size: 16px; transition: all 0.2s;
        }
        .search:focus { outline: none; border-color: #4299e1; box-shadow: 0 0 0 3px rgba(66, 153, 225, 0.1); }
        
        .legend {
            display: flex; gap: 20px; margin-top: 15px; flex-wrap: wrap; justify-content: center;
        }
        .legend-item {
            display: flex; align-items: center; gap: 8px; padding: 8px 16px;
            background: #f7fafc; border-radius: 20px; font-size: 14px;
        }
        .legend-dot { width: 14px; height: 14px; border-radius: 50%; }
        
        .analysis-panel {
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%);
            background: white; border-radius: 12px; padding: 30px; z-index: 1000;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3); max-width: 800px; max-height: 80vh;
            overflow-y: auto; display: none;
        }
        
        .overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0; 
            background: rgba(0,0,0,0.5); z-index: 999; display: none;
        }
        
        .close-btn {
            float: right; background: #e2e8f0; border: none; padding: 8px 12px;
            border-radius: 6px; cursor: pointer; margin-bottom: 15px;
        }
        .close-btn:hover { background: #cbd5e0; }
        
        .export-btn {
            background: #38a169; color: white; border: none; padding: 10px 20px; 
            border-radius: 6px; cursor: pointer; font-weight: 600; margin-left: 10px;
            transition: all 0.3s; font-size: 14px;
        }
        .export-btn:hover { 
            background: #2f855a; transform: translateY(-2px); 
            box-shadow: 0 4px 12px rgba(56, 161, 105, 0.3);
        }
        .export-btn.blue { background: #3182ce; }
        .export-btn.blue:hover { background: #2c5282; }
        
        #mainContent { display: none; }
        
        .example-note {
            background: #e6fffa; border: 2px solid #38b2ac; border-radius: 8px;
            padding: 15px; margin-top: 15px; color: #234e52;
        }
        
        .footer {
            text-align: center; padding: 20px; color: #718096; font-size: 14px;
            margin-top: 30px; border-top: 2px solid #e2e8f0;
        }
    </style>
</head>
<body>
    <div class="disclaimer">
        <strong>‚ö†Ô∏è Educational & Research Tool Disclaimer</strong>
        This is a generic RF engineering analysis tool developed for educational and research purposes. 
        It uses publicly available frequency allocation data and standard intermodulation calculation methods. 
        All calculations are based on well-established RF engineering principles. This tool does not contain 
        proprietary methodologies or client-specific data. Users are responsible for ensuring their input data 
        complies with applicable regulations and confidentiality requirements.
    </div>

    <div class="header">
        <h1>üî¨ ENDC Intermodulation Analysis Tool</h1>
        <p>Generic RF Engineering Tool ‚Ä¢ IM2/IM3 Calculations ‚Ä¢ Carrier Risk Assessment</p>
    </div>
    
    <div class="upload-section" id="uploadSection">
        <h2>üìÅ Upload Your ENDC Combinations Excel File</h2>
        <p>Select your Excel file containing ENDC carrier combinations for comprehensive IM analysis</p>
        
        <label for="fileInput" class="file-label">
            üìÇ Choose Excel File (.xlsx)
        </label>
        <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls">
        
        <div class="processing" id="processing">
            üîÑ Processing combinations and calculating IM risks...
        </div>
        
        <div class="example-note">
            <strong>üìã Expected Format:</strong> Excel file with column: [ENDC Combination]<br>
            <strong>Example:</strong> DC_1A-3A-8A-20A-38A_n78A or DC_2A-4A-66A_n77A<br>
            <strong>Supported Bands:</strong> LTE (1-71) and 5G NR (n1-n261) - See README for full list
        </div>
    </div>
    
    <div id="mainContent">
        <div class="stats" id="stats"></div>
        
        <div class="section">
            <h3>üéØ Carrier Risk Heatmap - Across All Combinations</h3>
            <p>Each carrier shows total risk score accumulated across all combinations where it appears. Higher scores indicate more IM interference potential.</p>
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="exportCarrierRisks()" class="export-btn">
                    üìä Export Carrier Risk Data
                </button>
            </div>
            <div class="carrier-heatmap" id="carrierHeatmap"></div>
        </div>
        
        <div class="controls">
            <input type="text" class="search" id="search" placeholder="üîç Search combinations (e.g., 'n78A', 'DC_1A-3A', 'B66')...">
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-dot" style="background: #e53e3e;"></div>
                    <span>Critical (‚â•10.0) - Major IM issues</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #dd6b20;"></div>
                    <span>High (5.0-9.9) - Significant IM</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #3182ce;"></div>
                    <span>Medium (1.0-4.9) - Moderate IM</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #38a169;"></div>
                    <span>Low (0.1-0.9) - Minor IM</span>
                </div>
                <div class="legend-item">
                    <div class="legend-dot" style="background: #e2e8f0;"></div>
                    <span>Minimal (0.0) - No calculated IM</span>
                </div>
            </div>
        </div>
        
        <div class="section">
            <h3>üìã All Combinations - Ranked by IM Risk (Descending)</h3>
            <div style="text-align: right; margin-bottom: 15px;">
                <button onclick="exportCombinationsRanking()" class="export-btn blue">
                    üìã Export Combinations Ranking
                </button>
            </div>
            <div style="overflow-x: auto;">
                <table class="combinations-table">
                    <thead>
                        <tr>
                            <th style="width: 60px;">Rank</th>
                            <th style="width: 300px;">ENDC Combination</th>
                            <th style="width: 100px;">Risk Score</th>
                            <th style="width: 80px;">IM2</th>
                            <th style="width: 80px;">IM3</th>
                            <th>Main Interferences</th>
                        </tr>
                    </thead>
                    <tbody id="combinationsTable"></tbody>
                </table>
            </div>
        </div>
    </div>
    
    <div class="overlay" id="overlay" onclick="hideAnalysisPanel()"></div>
    <div class="analysis-panel" id="analysisPanel">
        <button class="close-btn" onclick="hideAnalysisPanel()">‚úï Close</button>
        <div id="panelContent"></div>
    </div>

    <div class="footer">
        <p><strong>ENDC IM Analysis Tool</strong> - Generic RF Engineering Educational Tool</p>
        <p>Based on publicly available frequency allocation data and standard RF engineering principles</p>
        <p>¬© 2025 - Open Source Educational Project</p>
    </div>

    <script>
        // Comprehensive international frequency data (MHz) - Based on 3GPP specifications
        // This is publicly available information from ITU and 3GPP standards
        const frequencies = {
            // LTE Bands - Common international allocations
            '1A': {ul: [1920, 1980], dl: [2110, 2170], region: 'Global'},
            '2A': {ul: [1850, 1910], dl: [1930, 1990], region: 'Americas, APAC'},
            '3A': {ul: [1710, 1785], dl: [1805, 1880], region: 'Global'},
            '4A': {ul: [1710, 1755], dl: [2110, 2155], region: 'Americas'},
            '5A': {ul: [824, 849], dl: [869, 894], region: 'Americas, APAC'},
            '7A': {ul: [2500, 2570], dl: [2620, 2690], region: 'Global'},
            '8A': {ul: [880, 915], dl: [925, 960], region: 'Global'},
            '12A': {ul: [699, 716], dl: [729, 746], region: 'Americas'},
            '13A': {ul: [777, 787], dl: [746, 756], region: 'Americas'},
            '14A': {ul: [788, 798], dl: [758, 768], region: 'Americas'},
            '17A': {ul: [704, 716], dl: [734, 746], region: 'Americas'},
            '20A': {ul: [832, 862], dl: [791, 821], region: 'Europe, APAC'},
            '25A': {ul: [1850, 1915], dl: [1930, 1995], region: 'Americas'},
            '26A': {ul: [814, 849], dl: [859, 894], region: 'Americas'},
            '28A': {ul: [703, 748], dl: [758, 803], region: 'APAC'},
            '29A': {ul: [0, 0], dl: [717, 728], region: 'Americas'},
            '30A': {ul: [2305, 2315], dl: [2350, 2360], region: 'Americas'},
            '38A': {ul: [2570, 2620], dl: [2570, 2620], region: 'Global TDD'},
            '39A': {ul: [1880, 1920], dl: [1880, 1920], region: 'Asia TDD'},
            '40A': {ul: [2300, 2400], dl: [2300, 2400], region: 'Global TDD'},
            '40C': {ul: [2300, 2400], dl: [2300, 2400], region: 'Global TDD'},
            '41A': {ul: [2496, 2690], dl: [2496, 2690], region: 'Global TDD'},
            '41C': {ul: [2496, 2690], dl: [2496, 2690], region: 'Global TDD'},
            '42A': {ul: [3400, 3600], dl: [3400, 3600], region: 'Global TDD'},
            '43A': {ul: [3600, 3800], dl: [3600, 3800], region: 'Global TDD'},
            '46A': {ul: [5150, 5925], dl: [5150, 5925], region: 'Global TDD'},
            '48A': {ul: [3550, 3700], dl: [3550, 3700], region: 'Americas TDD'},
            '66A': {ul: [1710, 1780], dl: [2110, 2200], region: 'Americas'},
            '71A': {ul: [663, 698], dl: [617, 652], region: 'Americas'},
            
            // 5G NR Bands - Common international allocations
            'n1A': {ul: [1920, 1980], dl: [2110, 2170], region: 'Global'},
            'n2A': {ul: [1850, 1910], dl: [1930, 1990], region: 'Americas, APAC'},
            'n3A': {ul: [1710, 1785], dl: [1805, 1880], region: 'Global'},
            'n5A': {ul: [824, 849], dl: [869, 894], region: 'Americas, APAC'},
            'n7A': {ul: [2500, 2570], dl: [2620, 2690], region: 'Global'},
            'n8A': {ul: [880, 915], dl: [925, 960], region: 'Global'},
            'n12A': {ul: [699, 716], dl: [729, 746], region: 'Americas'},
            'n20A': {ul: [832, 862], dl: [791, 821], region: 'Europe, APAC'},
            'n25A': {ul: [1850, 1915], dl: [1930, 1995], region: 'Americas'},
            'n28A': {ul: [703, 748], dl: [758, 803], region: 'APAC'},
            'n38A': {ul: [2570, 2620], dl: [2570, 2620], region: 'Global TDD'},
            'n40A': {ul: [2300, 2400], dl: [2300, 2400], region: 'Global TDD'},
            'n41A': {ul: [2496, 2690], dl: [2496, 2690], region: 'Global TDD'},
            'n66A': {ul: [1710, 1780], dl: [2110, 2200], region: 'Americas'},
            'n71A': {ul: [663, 698], dl: [617, 652], region: 'Americas'},
            'n75A': {ul: [0, 0], dl: [1432, 1517], region: 'Europe'},
            'n76A': {ul: [0, 0], dl: [1427, 1432], region: 'Europe'},
            'n77A': {ul: [3300, 4200], dl: [3300, 4200], region: 'Global TDD'},
            'n78A': {ul: [3300, 3800], dl: [3300, 3800], region: 'Global TDD'},
            'n78(2A)': {ul: [3300, 3800], dl: [3300, 3800], region: 'Global TDD'},
            'n79A': {ul: [4400, 5000], dl: [4400, 5000], region: 'Asia TDD'},
            'n257A': {ul: [26500, 29500], dl: [26500, 29500], region: 'Global mmWave TDD'},
            'n258A': {ul: [24250, 27500], dl: [24250, 27500], region: 'Global mmWave TDD'},
            'n260A': {ul: [37000, 40000], dl: [37000, 40000], region: 'Global mmWave TDD'},
            'n261A': {ul: [27500, 28350], dl: [27500, 28350], region: 'Global mmWave TDD'}
        };

        let allCombinations = [];
        let carrierRisks = {};

        // Enhanced band parsing function
        function parseBandList(comboName) {
            const cleanName = comboName.replace('DC_', '');
            const parts = cleanName.split('_');
            const bands = [];
            
            parts.forEach(part => {
                if (part.includes('-')) {
                    bands.push(...part.split('-'));
                } else {
                    bands.push(part);
                }
            });
            
            return bands.filter(band => band && frequencies[band]);
        }

        // Standard IM2/IM3 calculation engine based on RF engineering principles
        function calculateIMRisk(bandList) {
            const interferences = [];
            let totalRisk = 0;
            let im2Count = 0;
            let im3Count = 0;

            for (let i = 0; i < bandList.length; i++) {
                for (let j = i + 1; j < bandList.length; j++) {
                    const band1 = bandList[i];
                    const band2 = bandList[j];
                    
                    if (!frequencies[band1] || !frequencies[band2]) continue;
                    
                    const f1 = frequencies[band1];
                    const f2 = frequencies[band2];
                    
                    // Calculate center frequencies
                    const f1Center = (f1.ul[0] + f1.ul[1]) / 2;
                    const f2Center = (f2.ul[0] + f2.ul[1]) / 2;
                    
                    // IM2 products (2nd order intermodulation)
                    const im2Products = [
                        {freq: 2 * f1Center, type: `2√ó${band1}`, desc: `2nd harmonic of ${band1}`},
                        {freq: 2 * f2Center, type: `2√ó${band2}`, desc: `2nd harmonic of ${band2}`},
                        {freq: f1Center + f2Center, type: `${band1}+${band2}`, desc: `Sum frequency`},
                        {freq: Math.abs(f1Center - f2Center), type: `|${band1}-${band2}|`, desc: `Difference frequency`}
                    ];
                    
                    // IM3 products (3rd order intermodulation)
                    const im3Products = [
                        {freq: Math.abs(2 * f1Center - f2Center), type: `2√ó${band1}-${band2}`, desc: `3rd order IM`},
                        {freq: Math.abs(2 * f2Center - f1Center), type: `2√ó${band2}-${band1}`, desc: `3rd order IM`}
                    ];
                    
                    // Check IM2 interference
                    im2Products.forEach(product => {
                        if (product.freq > 0) {
                            bandList.forEach(victimBand => {
                                const victim = frequencies[victimBand];
                                if (victim && (victimBand !== band1 && victimBand !== band2)) {
                                    const inUL = product.freq >= victim.ul[0] && product.freq <= victim.ul[1];
                                    const inDL = product.freq >= victim.dl[0] && product.freq <= victim.dl[1];
                                    
                                    if (inUL || inDL) {
                                        interferences.push({
                                            type: 'IM2',
                                            sources: [band1, band2],
                                            victim: victimBand,
                                            frequency: product.freq.toFixed(1),
                                            band: inUL ? 'UL' : 'DL',
                                            description: `${product.type} = ${product.freq.toFixed(1)} MHz ‚Üí ${victimBand} ${inUL ? 'UL' : 'DL'}`
                                        });
                                        totalRisk += 1.0;
                                        im2Count++;
                                    }
                                }
                            });
                        }
                    });
                    
                    // Check IM3 interference
                    im3Products.forEach(product => {
                        if (product.freq > 0) {
                            bandList.forEach(victimBand => {
                                const victim = frequencies[victimBand];
                                if (victim && (victimBand !== band1 && victimBand !== band2)) {
                                    const inUL = product.freq >= victim.ul[0] && product.freq <= victim.ul[1];
                                    const inDL = product.freq >= victim.dl[0] && product.freq <= victim.dl[1];
                                    
                                    if (inUL || inDL) {
                                        interferences.push({
                                            type: 'IM3',
                                            sources: [band1, band2],
                                            victim: victimBand,
                                            frequency: product.freq.toFixed(1),
                                            band: inUL ? 'UL' : 'DL',
                                            description: `${product.type} = ${product.freq.toFixed(1)} MHz ‚Üí ${victimBand} ${inUL ? 'UL' : 'DL'}`
                                        });
                                        totalRisk += 0.5;
                                        im3Count++;
                                    }
                                }
                            });
                        }
                    });
                }
            }

            return {
                riskScore: totalRisk,
                im2Count,
                im3Count,
                interferences,
                totalInterferences: interferences.length
            };
        }

        function getRiskLevel(score) {
            if (score >= 10.0) return 'critical';
            if (score >= 5.0) return 'high';
            if (score >= 1.0) return 'medium';
            if (score > 0) return 'low';
            return 'minimal';
        }

        // File upload handler
        document.getElementById('fileInput').addEventListener('change', function(e) {
            const file = e.target.files[0];
            if (!file) return;
            
            document.getElementById('processing').style.display = 'block';
            
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const data = new Uint8Array(e.target.result);
                    const workbook = XLSX.read(data, {type: 'array'});
                    const firstSheetName = workbook.SheetNames[0];
                    const worksheet = workbook.Sheets[firstSheetName];
                    const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
                    
                    processExcelData(jsonData);
                } catch (error) {
                    alert('Error reading Excel file: ' + error.message);
                    document.getElementById('processing').style.display = 'none';
                }
            };
            reader.readAsArrayBuffer(file);
        });

        function processExcelData(rawData) {
            const dataRows = rawData.slice(1);
            
            allCombinations = [];
            carrierRisks = {};
            
            console.log(`Processing ${dataRows.length} combinations...`);
            
            dataRows.forEach((row, index) => {
                const comboName = row[0];
                if (!comboName) return;
                
                const bandList = parseBandList(comboName);
                const analysis = calculateIMRisk(bandList);
                
                bandList.forEach(band => {
                    if (!carrierRisks[band]) {
                        carrierRisks[band] = {
                            totalRisk: 0,
                            appearances: 0,
                            im2Count: 0,
                            im3Count: 0
                        };
                    }
                    carrierRisks[band].totalRisk += analysis.riskScore;
                    carrierRisks[band].appearances++;
                    carrierRisks[band].im2Count += analysis.im2Count;
                    carrierRisks[band].im3Count += analysis.im3Count;
                });
                
                allCombinations.push({
                    name: comboName,
                    bands: bandList,
                    analysis: analysis
                });
            });
            
            allCombinations.sort((a, b) => b.analysis.riskScore - a.analysis.riskScore);
            
            displayResults();
        }

        function displayResults() {
            document.getElementById('uploadSection').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            document.getElementById('processing').style.display = 'none';
            
            displayStats();
            displayCarrierHeatmap();
            displayCombinationsTable();
            
            document.getElementById('search').addEventListener('input', filterCombinations);
        }

        function displayStats() {
            const totalCombos = allCombinations.length;
            const criticalCombos = allCombinations.filter(c => c.analysis.riskScore >= 10).length;
            const highCombos = allCombinations.filter(c => c.analysis.riskScore >= 5 && c.analysis.riskScore < 10).length;
            const avgRisk = (allCombinations.reduce((sum, c) => sum + c.analysis.riskScore, 0) / totalCombos).toFixed(2);
            
            document.getElementById('stats').innerHTML = `
                <div class="stat-card">
                    <div>Total Combinations</div>
                    <div class="stat-number">${totalCombos}</div>
                </div>
                <div class="stat-card">
                    <div>Critical Risk (‚â•10)</div>
                    <div class="stat-number" style="color: #e53e3e;">${criticalCombos}</div>
                </div>
                <div class="stat-card">
                    <div>High Risk (5-9.9)</div>
                    <div class="stat-number" style="color: #dd6b20;">${highCombos}</div>
                </div>
                <div class="stat-card">
                    <div>Average Risk Score</div>
                    <div class="stat-number">${avgRisk}</div>
                </div>
            `;
        }

        function displayCarrierHeatmap() {
            const sorted = Object.entries(carrierRisks).sort((a, b) => b[1].totalRisk - a[1].totalRisk);
            
            const html = sorted.map(([band, data]) => {
                const riskLevel = getRiskLevel(data.totalRisk);
                return `
                    <div class="carrier-cell risk-${riskLevel}" onclick="showCarrierDetails('${band}')">
                        <div class="carrier-name">${band}</div>
                        <div class="carrier-risk">${data.totalRisk.toFixed(1)}</div>
                        <div class="carrier-count">${data.appearances} combos</div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('carrierHeatmap').innerHTML = html;
        }

        function displayCombinationsTable(filter = '') {
            const filtered = filter ? 
                allCombinations.filter(c => c.name.toLowerCase().includes(filter.toLowerCase())) :
                allCombinations;
            
            const html = filtered.map((combo, index) => {
                const riskLevel = getRiskLevel(combo.analysis.riskScore);
                const mainInterferences = combo.analysis.interferences.slice(0, 3)
                    .map(i => `<span class="${i.type.toLowerCase()}">${i.description}</span>`)
                    .join('<br>');
                
                return `
                    <tr onclick="showCombinationDetails('${combo.name}')">
                        <td>${index + 1}</td>
                        <td><strong>${combo.name}</strong></td>
                        <td><span class="risk-score score-${riskLevel}">${combo.analysis.riskScore.toFixed(1)}</span></td>
                        <td>${combo.analysis.im2Count}</td>
                        <td>${combo.analysis.im3Count}</td>
                        <td>${mainInterferences || 'No IM detected'}</td>
                    </tr>
                `;
            }).join('');
            
            document.getElementById('combinationsTable').innerHTML = html;
        }

        function filterCombinations(e) {
            displayCombinationsTable(e.target.value);
        }

        function showCarrierDetails(band) {
            const data = carrierRisks[band];
            const combosWithBand = allCombinations.filter(c => c.bands.includes(band));
            
            const freqInfo = frequencies[band];
            const freqText = freqInfo.ul[0] === 0 ? 
                `DL: ${freqInfo.dl[0]}-${freqInfo.dl[1]} MHz` :
                `UL: ${freqInfo.ul[0]}-${freqInfo.ul[1]} MHz, DL: ${freqInfo.dl[0]}-${freqInfo.dl[1]} MHz`;
            
            const content = `
                <h2>üì° Carrier: ${band}</h2>
                <p><strong>Region:</strong> ${freqInfo.region}</p>
                <p><strong>Frequencies:</strong> ${freqText}</p>
                <p><strong>Total Risk Score:</strong> ${data.totalRisk.toFixed(2)}</p>
                <p><strong>Appears in:</strong> ${data.appearances} combinations</p>
                <p><strong>IM2 Count:</strong> ${data.im2Count}</p>
                <p><strong>IM3 Count:</strong> ${data.im3Count}</p>
                <h3>Combinations containing ${band}:</h3>
                <div style="max-height: 400px; overflow-y: auto;">
                    ${combosWithBand.map(c => `
                        <div style="padding: 10px; border-bottom: 1px solid #e2e8f0;">
                            <strong>${c.name}</strong> - Risk: ${c.analysis.riskScore.toFixed(1)}
                        </div>
                    `).join('')}
                </div>
            `;
            
            showAnalysisPanel(content);
        }

        function showCombinationDetails(comboName) {
            const combo = allCombinations.find(c => c.name === comboName);
            
            const content = `
                <h2>üìã ${combo.name}</h2>
                <p><strong>Bands:</strong> ${combo.bands.join(', ')}</p>
                <p><strong>Risk Score:</strong> ${combo.analysis.riskScore.toFixed(2)}</p>
                <p><strong>IM2 Count:</strong> ${combo.analysis.im2Count}</p>
                <p><strong>IM3 Count:</strong> ${combo.analysis.im3Count}</p>
                <h3>All Interferences:</h3>
                <div class="interference-list">
                    ${combo.analysis.interferences.map(i => `
                        <div class="interference-item">
                            <span class="${i.type.toLowerCase()}">${i.type}</span>: ${i.description}
                        </div>
                    `).join('') || 'No interferences detected'}
                </div>
            `;
            
            showAnalysisPanel(content);
        }

        function showAnalysisPanel(content) {
            document.getElementById('panelContent').innerHTML = content;
            document.getElementById('overlay').style.display = 'block';
            document.getElementById('analysisPanel').style.display = 'block';
        }

        function hideAnalysisPanel() {
            document.getElementById('overlay').style.display = 'none';
            document.getElementById('analysisPanel').style.display = 'none';
        }

        function exportCarrierRisks() {
            const data = Object.entries(carrierRisks).map(([band, data]) => ({
                'Carrier': band,
                'Region': frequencies[band].region,
                'Total Risk Score': parseFloat(data.totalRisk.toFixed(2)),
                'Appearances': data.appearances,
                'IM2 Count': data.im2Count,
                'IM3 Count': data.im3Count,
                'Average Risk per Combo': parseFloat((data.totalRisk / data.appearances).toFixed(2))
            }));
            
            data.sort((a, b) => b['Total Risk Score'] - a['Total Risk Score']);
            
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.json_to_sheet(data);
            
            ws['!cols'] = [
                {wch: 12}, {wch: 20}, {wch: 15}, {wch: 12}, 
                {wch: 12}, {wch: 12}, {wch: 20}
            ];
            
            XLSX.utils.book_append_sheet(wb, ws, "Carrier Risk Analysis");
            
            const fileName = `Carrier_Risk_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function exportCombinationsRanking() {
            const wb = XLSX.utils.book_new();
            
            const summaryData = allCombinations.map((combo, index) => ({
                'Rank': index + 1,
                'ENDC Combination': combo.name,
                'Risk Score': parseFloat(combo.analysis.riskScore.toFixed(2)),
                'Risk Level': getRiskLevel(combo.analysis.riskScore).toUpperCase(),
                'IM2 Count': combo.analysis.im2Count,
                'IM3 Count': combo.analysis.im3Count,
                'Total Interferences': combo.analysis.totalInterferences,
                'Bands': combo.bands.join(', '),
                'Main Interferences': combo.analysis.interferences.slice(0, 5)
                    .map(i => i.description).join(' | ')
            }));
            
            const ws1 = XLSX.utils.json_to_sheet(summaryData);
            XLSX.utils.book_append_sheet(wb, ws1, "Combinations Ranking");
            
            ws1['!cols'] = [
                {wch: 6}, {wch: 35}, {wch: 12}, {wch: 12},
                {wch: 8}, {wch: 8}, {wch: 15}, {wch: 25}, {wch: 50}
            ];
            
            const detailedData = [];
            allCombinations.forEach(combo => {
                combo.analysis.interferences.forEach(interference => {
                    detailedData.push({
                        'Combination': combo.name,
                        'Combination Risk Score': parseFloat(combo.analysis.riskScore.toFixed(2)),
                        'Interference Type': interference.type,
                        'Source Bands': interference.sources.join(' + '),
                        'Victim Band': interference.victim,
                        'Frequency (MHz)': parseFloat(interference.frequency),
                        'Frequency Band': interference.band || 'N/A',
                        'Description': interference.description,
                        'Individual Risk': interference.type === 'IM2' ? 1.0 : 0.5
                    });
                });
            });
            
            if (detailedData.length > 0) {
                const ws2 = XLSX.utils.json_to_sheet(detailedData);
                XLSX.utils.book_append_sheet(wb, ws2, "Detailed Interferences");
                
                ws2['!cols'] = [
                    {wch: 35}, {wch: 18}, {wch: 15}, {wch: 15},
                    {wch: 12}, {wch: 15}, {wch: 12}, {wch: 50}, {wch: 12}
                ];
            }
            
            const fileName = `ENDC_Combinations_Analysis_${new Date().toISOString().split('T')[0]}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
